# 测试用例运行说明

## 已创建的测试用例

### 1. Controller层测试（API集成测试）

- **ObjectTypeControllerTest** - 对象类型API测试
  - ✅ 创建对象类型
  - ✅ 根据ID查询
  - ✅ 根据名称查询
  - ✅ 列表查询（分页）
  - ✅ 更新对象类型
  - ✅ 删除对象类型
  - ✅ 数据验证测试

- **PropertyControllerTest** - 属性API测试
  - ✅ 创建属性
  - ✅ 查询属性
  - ✅ 更新属性
  - ✅ 删除属性
  - ✅ 重复名称测试

- **LinkTypeControllerTest** - 链接类型API测试
  - ✅ 创建链接类型
  - ✅ 查询链接类型
  - ✅ 更新链接类型
  - ✅ 删除链接类型
  - ✅ 对象类型关联查询

- **InstanceControllerTest** - 实例API测试
  - ✅ 创建实例
  - ✅ 查询实例
  - ✅ 列表查询
  - ✅ 更新实例
  - ✅ 删除实例

### 2. Service层测试

- **InstanceServiceTest** - 实例服务测试
  - ✅ 创建实例
  - ✅ 查询实例
  - ✅ 更新实例
  - ✅ 列表查询（带过滤）
  - ✅ 删除实例
  - ✅ 批量删除
  - ✅ 数据验证（必需字段、默认值）

## 运行测试

### 方式一：使用IDE运行（推荐）

#### IntelliJ IDEA
1. 打开项目
2. 在测试类上右键 -> Run Tests
3. 或在测试方法上右键 -> Run Test

#### Eclipse
1. 打开项目
2. 右键测试类 -> Run As -> JUnit Test

### 方式二：使用Maven命令

```bash
# 进入backend目录
cd backend

# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=ObjectTypeControllerTest

# 运行特定测试方法
mvn test -Dtest=ObjectTypeControllerTest#testCreateObjectType

# 跳过测试编译，只运行测试
mvn surefire:test
```

## 测试配置

### 数据库配置

测试使用 `application-test.yml` 配置文件，默认使用PostgreSQL数据库。

**重要**：运行测试前需要：

1. **创建测试数据库**
   ```sql
   CREATE DATABASE datamodel_test;
   ```

2. **执行数据库初始化脚本**
   ```sql
   -- 执行 backend/src/main/resources/db/migration/V1__Initial_schema.sql
   ```

3. **修改测试配置**（如果需要）
   - 编辑 `src/test/resources/application-test.yml`
   - 修改数据库连接信息

### 可选：使用H2内存数据库

如果想使用H2内存数据库（无需额外配置），可以：

1. 在 `pom.xml` 中添加H2依赖（测试范围）
2. 修改 `application-test.yml` 使用H2配置

## 测试特性

### 事务回滚
- 所有测试类都使用 `@Transactional` 注解
- 测试结束后数据会自动回滚
- 不会影响开发数据库的数据

### 测试数据清理
- 每个测试类的 `@BeforeEach` 方法会清理测试数据
- 确保测试环境干净，避免数据冲突

### 独立测试
- 每个测试方法相互独立
- 可以任意顺序运行
- 可以单独运行某个测试

## 测试结果示例

运行测试后，你会看到类似以下的输出：

```
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running com.example.datamodel.controller.v1.ObjectTypeControllerTest
[INFO] Tests run: 8, Failures: 0, Errors: 0, Skipped: 0
[INFO] Running com.example.datamodel.controller.v1.PropertyControllerTest
[INFO] Tests run: 6, Failures: 0, Errors: 0, Skipped: 0
...
[INFO] -------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] -------------------------------------------------------
```

## 常见问题

### 1. 数据库连接失败

**错误**: `Connection refused` 或 `Authentication failed`

**解决**:
- 确保PostgreSQL服务运行
- 检查 `application-test.yml` 中的数据库配置
- 确认测试数据库已创建

### 2. 测试数据冲突

**错误**: 测试失败，提示数据已存在

**解决**:
- 检查 `@BeforeEach` 方法是否正确清理数据
- 确保使用了 `@Transactional` 注解
- 检查是否有其他测试进程在运行

### 3. 测试超时

**错误**: 测试执行时间过长

**解决**:
- 检查数据库连接是否正常
- 检查是否有死锁或长时间运行的查询
- 考虑使用H2内存数据库加速测试

## 下一步

可以继续添加以下测试：

1. **查询引擎测试** - QueryEngineTest
2. **接口管理测试** - InterfaceControllerTest
3. **函数管理测试** - FunctionControllerTest
4. **操作类型测试** - ActionTypeControllerTest
5. **链接实例测试** - LinkInstanceControllerTest

## 测试覆盖率

运行测试后可以使用JaCoCo查看覆盖率：

```bash
# 添加JaCoCo插件到pom.xml后
mvn clean test jacoco:report

# 查看报告
# target/site/jacoco/index.html
```

